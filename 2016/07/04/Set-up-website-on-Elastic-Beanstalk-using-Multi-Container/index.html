<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Set up website on Elastic Beanstalk using Multi Container | System Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Set up website on Elastic Beanstalk using Multi Container (PHP-FPM + Nginx)This guide shows you how to setup WebApp  on Elastic Beanstalk using the [PHP-FPM]and [Nginx] Docker images.
The procedure of">
<meta property="og:type" content="article">
<meta property="og:title" content="Set up website on Elastic Beanstalk using Multi Container">
<meta property="og:url" content="https://christhai.github.io/2016/07/04/Set-up-website-on-Elastic-Beanstalk-using-Multi-Container/index.html">
<meta property="og:site_name" content="System Admin">
<meta property="og:description" content="Set up website on Elastic Beanstalk using Multi Container (PHP-FPM + Nginx)This guide shows you how to setup WebApp  on Elastic Beanstalk using the [PHP-FPM]and [Nginx] Docker images.
The procedure of">
<meta property="og:image" content="https://christhai.github.io/images/201607/image_6.png">
<meta property="og:updated_time" content="2016-07-04T19:57:08.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Set up website on Elastic Beanstalk using Multi Container">
<meta name="twitter:description" content="Set up website on Elastic Beanstalk using Multi Container (PHP-FPM + Nginx)This guide shows you how to setup WebApp  on Elastic Beanstalk using the [PHP-FPM]and [Nginx] Docker images.
The procedure of">
<meta name="twitter:image" content="https://christhai.github.io/images/201607/image_6.png">
  
    <link rel="alternative" href="/atom.xml" title="System Admin" type="application/atom+xml">
  
  
    <link rel="icon" href="img/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="favicon.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Jonathan Wu</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						
						<li>About</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Posts</a></li>
				        
							<li><a href="/images">Photo</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/christhai" title="github">github</a>
					        
								<a class="facebook" target="_blank" href="/facebook.com/jonathan.wu.0828" title="facebook">facebook</a>
					        
								<a class="linkedin" target="_blank" href="#" title="linkedin">linkedin</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Git/" style="font-size: 10px;">Git</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">Jonathan Hai Wu</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Jonathan Wu</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="favicon.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Jonathan Wu</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Posts</a></li>
		        
					<li><a href="/images">Photo</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/christhai" title="github">github</a>
			        
						<a class="facebook" target="_blank" href="/facebook.com/jonathan.wu.0828" title="facebook">facebook</a>
			        
						<a class="linkedin" target="_blank" href="#" title="linkedin">linkedin</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-Set-up-website-on-Elastic-Beanstalk-using-Multi-Container" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/04/Set-up-website-on-Elastic-Beanstalk-using-Multi-Container/" class="article-date">
  	<time datetime="2016-07-04T19:00:49.000Z" itemprop="datePublished">2016-07-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Set up website on Elastic Beanstalk using Multi Container
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Set-up-website-on-Elastic-Beanstalk-using-Multi-Container-PHP-FPM-Nginx"><a href="#Set-up-website-on-Elastic-Beanstalk-using-Multi-Container-PHP-FPM-Nginx" class="headerlink" title="Set up website on Elastic Beanstalk using Multi Container (PHP-FPM + Nginx)"></a>Set up website on Elastic Beanstalk using Multi Container (PHP-FPM + Nginx)</h2><p>This guide shows you how to setup WebApp  on Elastic Beanstalk using the [PHP-FPM]and [Nginx] Docker images.</p>
<h2 id="The-procedure-of-making-this-work"><a href="#The-procedure-of-making-this-work" class="headerlink" title="The procedure of making this work"></a>The procedure of making this work</h2><p><a href="#heading=h.rilr6oluuna3">First step, covert docker compose file to Dockerrun.aws.json</a></p>
<p><a href="#heading=h.txmc5fcrcsi1">Second step, link to RDS</a></p>
<p>—-&gt;   Think of security group, the instance  need access to RDS</p>
<p>—-&gt;   Connecting MYSQL RDS needs php-mysql inside docker</p>
<p>—-&gt;   Upload prebuild or private docker image (PHP with php-mysql) to ECR</p>
<hr>
<a id="more"></a>
<h3 id="First-step-covert-docker-compose-file-to-Dockerrun-aws-json"><a href="#First-step-covert-docker-compose-file-to-Dockerrun-aws-json" class="headerlink" title="First step, covert docker compose file to Dockerrun.aws.json"></a>First step, covert docker compose file to <a href="https://github.com/highcharts/www.highcharts.com/blob/eb_deploy/Dockerrun.aws.json" target="_blank" rel="external">Dockerrun.aws.json</a></h3><p>Follow this tutorial  <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker_ecstutorial.html" target="_blank" rel="external">http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker_ecstutorial.html</a></p>
<p><strong>Topics</strong></p>
<ul>
<li><p><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker_ecstutorial.html#create_deploy_docker_ecstutorial_role" target="_blank" rel="external">Configure a Container Instance IAM Role</a></p>
</li>
<li><p><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker_ecstutorial.html#create_deploy_docker_ecstutorial_config" target="_blank" rel="external">Define Docker Containers</a></p>
</li>
<li><p><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker_ecstutorial.html#create_deploy_docker_ecstutorial_code" target="_blank" rel="external">Add Content</a></p>
</li>
<li><p><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker_ecstutorial.html#create_deploy_docker_ecstutorial_deploy" target="_blank" rel="external">Deploy to Elastic Beanstalk</a></p>
</li>
<li><p><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker_ecstutorial.html#create_deploy_docker_ecstutorial_connect" target="_blank" rel="external">Connect to a Container Instance</a></p>
</li>
<li><p><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker_ecstutorial.html#create_deploy_docker_ecstutorial_connect_inspect" target="_blank" rel="external">Inspect the Amazon ECS Container Agent</a></p>
</li>
</ul>
<p>PS: you can login to the EC2 instance which host docker containers and  the WebAPP could be found on /var/app/current:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-10-0-0-117 ~]$ ls /var/app/current</span><br><span class="line">Dockerrun.aws.json  php-app  proxy</span><br></pre></td></tr></table></figure>
<p>Until now, the webapp is running without the mysql connection</p>
<h3 id="Second-step-link-to-RDS-Mysql"><a href="#Second-step-link-to-RDS-Mysql" class="headerlink" title="Second step, link to RDS Mysql"></a>Second step, link to RDS Mysql</h3><h4 id="1-Think-of-security-group-the-instance-need-access-to-RDS"><a href="#1-Think-of-security-group-the-instance-need-access-to-RDS" class="headerlink" title="1. Think of security group, the instance  need access to RDS"></a>1. Think of security group, the instance  need access to RDS</h4><p><a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_WorkingWithSecurityGroups.html#USER_WorkingWithSecurityGroups.AuthorizingEC2" target="_blank" rel="external">http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_WorkingWithSecurityGroups.html#USER_WorkingWithSecurityGroups.AuthorizingEC2</a></p>
<p>Login into EC2 instance and see whether can be able to visit RDS</p>
<p>troubleshooting</p>
<p><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/java-rds.html#create_deploy_Java.rds.troubleshooting" target="_blank" rel="external">http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/java-rds.html#create_deploy_Java.rds.troubleshooting</a></p>
<p>More reference:</p>
<p><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_PHP.rds.html" target="_blank" rel="external">http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_PHP.rds.html</a></p>
<p><a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/AWSHowTo.RDS.html" target="_blank" rel="external">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/AWSHowTo.RDS.html</a></p>
<p><a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/AWSHowTo.RDS.html#rds-external-ec2classic" target="_blank" rel="external">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/AWSHowTo.RDS.html#rds-external-ec2classic</a></p>
<p>So far, EC2 instance can access to RDS mysql however Webapp still not work.</p>
<p>We need mysql client to connect BY USING php-mysql</p>
<h4 id="2-Connecting-MYSQL-RDS-needs-php-mysql-inside-docker"><a href="#2-Connecting-MYSQL-RDS-needs-php-mysql-inside-docker" class="headerlink" title="2. Connecting MYSQL RDS needs php-mysql inside docker"></a>2. Connecting MYSQL RDS needs php-mysql inside docker</h4><p>Firstly, I add one more database container and test. It was not working.<br>Then I realized I do not need a separate DB container actually. The thing I need is the prebuild or private docker image (PHP with php-mysql)**</p>
<p>Here is a good doc i followed that solved this:</p>
<p><a href="http://www.michaelgallego.fr/blog/2015/07/18/using-elastic-beanstalk-multi-container-with-php/" target="_blank" rel="external">http://www.michaelgallego.fr/blog/2015/07/18/using-elastic-beanstalk-multi-container-with-php/</a></p>
<p>I wanna use docker private images (haiw/php-fpm) in Dockerrun.aws.json, but after testing, I found that it is not allowed and it cause deploy issue.  </p>
<p>Need to figure out a alternative way.</p>
<h4 id="3-Upload-prebuild-or-private-docker-image-PHP-with-php-mysql-to-ECR"><a href="#3-Upload-prebuild-or-private-docker-image-PHP-with-php-mysql-to-ECR" class="headerlink" title="3. Upload prebuild or private docker image (PHP with php-mysql) to ECR"></a>3. Upload prebuild or private docker image (PHP with php-mysql) to ECR</h4><p>Toturial:<br><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker.html#docker-images-private" target="_blank" rel="external">http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker.html#docker-images-private</a></p>
<p>Here is what I did,  </p>
<p><a href="http://aws.amazon.com/ecr/getting-started/" target="_blank" rel="external">http://aws.amazon.com/ecr/getting-started/</a></p>
<p>upload docker image to Amazon ECR to use</p>
<p><img src="images/201607/image_6.png" alt="image alt text"></p>
<p><a href="http://docs.aws.amazon.com/AmazonECR/latest/userguide/get-set-up-for-amazon-ecr.html" target="_blank" rel="external">http://docs.aws.amazon.com/AmazonECR/latest/userguide/get-set-up-for-amazon-ecr.html</a></p>
<p>Commands review:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">543  aws ecr get-login --region us-east-1</span><br><span class="line"></span><br><span class="line">544  aws configure</span><br><span class="line"></span><br><span class="line">545  aws ecr get-login --region us-east-1</span><br><span class="line"></span><br><span class="line">546  ls</span><br><span class="line"></span><br><span class="line">547  docker login -u AWS -p CiBwm0YaISJ</span><br><span class="line"></span><br><span class="line">566  docker build -t haiw/php-fpm:latest .</span><br><span class="line"></span><br><span class="line">567  docker images</span><br><span class="line"></span><br><span class="line">568  docker tag  haiw/php-fpm:latest 429834746942.dkr.ecr.us-east-1.amazonaws.com/php-fpm:latest</span><br><span class="line"></span><br><span class="line">569  docker push 429834746942.dkr.ecr.us-east-1.amazonaws.com/php-fpm:latest</span><br></pre></td></tr></table></figure>
<p>EB APP use docker image from ECR, it also requires permission</p>
<h4 id="4-Configure-Container-Instance-IAM-Role"><a href="#4-Configure-Container-Instance-IAM-Role" class="headerlink" title="4.Configure Container Instance IAM Role"></a>4.Configure Container Instance IAM Role</h4><p>Instances in a multicontainer Docker environment must have an instance profile with permission to access Amazon EC2 Container Service (Amazon ECS), the service that Elastic Beanstalk uses to coordinate container deployments. To grant Amazon ECS access to the instances in your environment, you must create an IAM container instance policy and attach the policy to the correct IAM role.</p>
<p><strong>Topics</strong></p>
<ul>
<li><p><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker_ecstutorial.html#create-policy" target="_blank" rel="external">Create the Policy</a></p>
</li>
<li><p><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker_ecstutorial.html#create-role" target="_blank" rel="external">Create the Role (if needed)</a></p>
</li>
<li><p><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker_ecstutorial.html#attach-policy" target="_blank" rel="external">Attach the Policy to the Role</a></p>
</li>
</ul>
<p>Conclude:<br>EC2 instance needs security group   and   IAM  role   </p>
<p><strong>让rds给instance  权限 从rds 的 security groups中去授权</strong></p>
<p><strong>而instance访问 ecs 或者 ecr 在 IAM中设置 </strong></p>
<p>给 <strong>aws-elasticbeanstalk-ec2-role</strong> 授予权限</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/07/04/Using-EB-CLI/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Using EB CLI
        
      </div>
    </a>
  
  
    <a href="/2016/06/29/Create-a-new-php-fpm-docker-image-on-AWS-ECR/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Create a new php-fpm docker image on AWS ECR</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>








</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Jonathan Wu
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>